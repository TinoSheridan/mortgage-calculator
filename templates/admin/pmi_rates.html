{% extends "admin/base_admin.html" %}

{% block title %}PMI Rates - Mortgage Calculator{% endblock %}

{% block admin_title %}PMI Rates{% endblock %}

{% block admin_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="card-title mb-0">PMI Rates Management</h5>
                        <p class="text-muted small">Configure Private Mortgage Insurance (PMI) rates for different loan types</p>
                    </div>
                </div>

                <!-- Alert for notifications -->
                <div id="pmiAlert" class="alert d-none" role="alert"></div>

                <div class="accordion" id="pmiAccordion">
                    <!-- VA Funding Fee Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vaFundingFee">
                                VA Loan Funding Fees
                            </button>
                        </h2>
                        <div id="vaFundingFee" class="accordion-collapse collapse" data-bs-parent="#pmiAccordion">
                            <div class="accordion-body">
                                <form id="vaFundingFeeForm" data-loan-type="va">
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">VA Funding Fee Rates</h6>
                                                        <span class="badge bg-info" data-bs-toggle="tooltip" title="VA funding fees are one-time charges collected at closing.">
                                                            <i class="fas fa-info-circle"></i> One-time Fee
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p class="text-muted small mb-4">
                                                        VA loans do not have monthly PMI but instead have a one-time funding fee
                                                        that varies based on the down payment and service status.
                                                    </p>

                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-bordered">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Type of Service</th>
                                                                    <th>Down Payment</th>
                                                                    <th>First Use</th>
                                                                    <th>Subsequent Use</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td rowspan="3" class="align-middle fw-bold">Active Duty/Veteran</td>
                                                                    <td>Less than 5%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="active" data-down-payment="less_than_5" data-use="first"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('active', {}).get('less_than_5', {}).get('first', 2.3)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="active" data-down-payment="less_than_5" data-use="subsequent"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('active', {}).get('less_than_5', {}).get('subsequent', 3.6)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td>5% to 9.99%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="active" data-down-payment="5_to_10" data-use="first"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('active', {}).get('5_to_10', {}).get('first', 1.65)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="active" data-down-payment="5_to_10" data-use="subsequent"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('active', {}).get('5_to_10', {}).get('subsequent', 1.65)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td>10% or more</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="active" data-down-payment="10_or_more" data-use="first"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('active', {}).get('10_or_more', {}).get('first', 1.4)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="active" data-down-payment="10_or_more" data-use="subsequent"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('active', {}).get('10_or_more', {}).get('subsequent', 1.4)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td rowspan="3" class="align-middle fw-bold">Reserves/National Guard</td>
                                                                    <td>Less than 5%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="reserves" data-down-payment="less_than_5" data-use="first"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('reserves', {}).get('less_than_5', {}).get('first', 2.3)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="reserves" data-down-payment="less_than_5" data-use="subsequent"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('reserves', {}).get('less_than_5', {}).get('subsequent', 3.6)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td>5% to 9.99%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="reserves" data-down-payment="5_to_10" data-use="first"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('reserves', {}).get('5_to_10', {}).get('first', 1.65)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="reserves" data-down-payment="5_to_10" data-use="subsequent"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('reserves', {}).get('5_to_10', {}).get('subsequent', 1.65)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td>10% or more</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="reserves" data-down-payment="10_or_more" data-use="first"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('reserves', {}).get('10_or_more', {}).get('first', 1.4)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control va-funding-fee"
                                                                                data-service="reserves" data-down-payment="10_or_more" data-use="subsequent"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('va', {}).get('funding_fee', {}).get('reserves', {}).get('10_or_more', {}).get('subsequent', 1.4)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="4">
                                                                        <div class="form-check form-switch">
                                                                            <input class="form-check-input" type="checkbox" id="vaDisabilityExemption"
                                                                                   {% if pmi_rates.get('va', {}).get('funding_fee', {}).get('disability_exempt', true) %}checked{% endif %}>
                                                                            <label class="form-check-label" for="vaDisabilityExemption">
                                                                                Exempt VA disability recipients (recommended)
                                                                            </label>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-outline-primary" id="saveVaFundingFeeBtn">
                                            <i class="fas fa-save me-1"></i> Save VA Funding Fee Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- FHA Mortgage Insurance Premium Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fhaMip">
                                FHA Mortgage Insurance Premium (MIP)
                            </button>
                        </h2>
                        <div id="fhaMip" class="accordion-collapse collapse" data-bs-parent="#pmiAccordion">
                            <div class="accordion-body">
                                <form id="fhaMipForm" data-loan-type="fha">
                                    <!-- Upfront MIP Section -->
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">Upfront Mortgage Insurance Premium (UFMIP)</h6>
                                                        <span class="badge bg-info" data-bs-toggle="tooltip" title="Upfront MIP is a one-time charge collected at closing, which can also be financed into the loan amount.">
                                                            <i class="fas fa-info-circle"></i> One-time Fee
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p class="text-muted small mb-4">
                                                        FHA loans require an upfront MIP payment at closing, as well as annual MIP payments that are included in the monthly mortgage payment.
                                                    </p>

                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Upfront MIP Rate</label>
                                                                <div class="input-group">
                                                                    <input type="number" class="form-control fha-upfront-rate"
                                                                        step="0.001" min="0" max="5"
                                                                        value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('upfront_mip_rate', 1.75)) }}">
                                                                    <span class="input-group-text">%</span>
                                                                </div>
                                                                <div class="form-text">Standard rate is 1.75% of the base loan amount</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Annual MIP Section -->
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">Annual MIP Rates</h6>
                                                        <span class="badge bg-primary" data-bs-toggle="tooltip" title="Annual MIP is charged as part of the monthly mortgage payment.">
                                                            <i class="fas fa-info-circle"></i> Monthly Payment
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p class="text-muted small mb-4">
                                                        Annual MIP rates vary based on loan terms, loan amounts, and down payment percentages.
                                                        The standard loan limit shown ($726,200) is for most areas and is adjusted annually.
                                                    </p>

                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-bordered">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Loan Term</th>
                                                                    <th>Base Loan Amount</th>
                                                                    <th>LTV Ratio</th>
                                                                    <th>Annual MIP Rate</th>
                                                                    <th>Duration</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <!-- Long-term loans (>15 years) with standard loan amount -->
                                                                <tr>
                                                                    <td rowspan="4" class="align-middle">Over 15 years</td>
                                                                    <td rowspan="2" class="align-middle">≤ $726,200</td>
                                                                    <td>≤ 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="long" data-amount="standard" data-ltv="low"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('long_term', {}).get('standard_amount', {}).get('low_ltv', 0.50)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>11 years</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>> 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="long" data-amount="standard" data-ltv="high"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('long_term', {}).get('standard_amount', {}).get('high_ltv', 0.55)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>Life of loan</td>
                                                                </tr>

                                                                <!-- Long-term loans (>15 years) with high loan amount -->
                                                                <tr>
                                                                    <td rowspan="2" class="align-middle">> $726,200</td>
                                                                    <td>≤ 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="long" data-amount="high" data-ltv="low"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('long_term', {}).get('high_amount', {}).get('low_ltv', 0.70)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>11 years</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>> 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="long" data-amount="high" data-ltv="high"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('long_term', {}).get('high_amount', {}).get('high_ltv', 0.75)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>Life of loan</td>
                                                                </tr>

                                                                <!-- Short-term loans (≤15 years) with standard loan amount -->
                                                                <tr>
                                                                    <td rowspan="5" class="align-middle">15 years or less</td>
                                                                    <td rowspan="2" class="align-middle">≤ $726,200</td>
                                                                    <td>≤ 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="short" data-amount="standard" data-ltv="low"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('short_term', {}).get('standard_amount', {}).get('low_ltv', 0.15)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>11 years</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>> 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="short" data-amount="standard" data-ltv="high"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('short_term', {}).get('standard_amount', {}).get('high_ltv', 0.40)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>Life of loan</td>
                                                                </tr>

                                                                <!-- Short-term loans (≤15 years) with high loan amount -->
                                                                <tr>
                                                                    <td rowspan="3" class="align-middle">> $726,200</td>
                                                                    <td>≤ 78%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="short" data-amount="high" data-ltv="very_low"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('short_term', {}).get('high_amount', {}).get('very_low_ltv', 0.15)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>11 years</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>> 78% and ≤ 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="short" data-amount="high" data-ltv="low"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('short_term', {}).get('high_amount', {}).get('low_ltv', 0.40)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>11 years</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>> 90%</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fha-annual-mip"
                                                                                data-term="short" data-amount="high" data-ltv="high"
                                                                                step="0.001" min="0" max="2"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('fha', {}).get('annual_mip', {}).get('short_term', {}).get('high_amount', {}).get('high_ltv', 0.65)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                    </td>
                                                                    <td>Life of loan</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>

                                                    <div class="mt-4">
                                                        <h6>Additional Settings</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Standard Loan Limit</label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">$</span>
                                                                        <input type="number" class="form-control" id="fhaStandardLoanLimit"
                                                                            step="1000" min="0"
                                                                            value="{{ pmi_rates.get('fha', {}).get('standard_loan_limit', 726200) }}">
                                                                    </div>
                                                                    <div class="form-text">The threshold between standard and high-cost loans (2023-2024: $726,200)</div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">High-Cost Loan Limit</label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">$</span>
                                                                        <input type="number" class="form-control" id="fhaHighCostLoanLimit"
                                                                            step="1000" min="0"
                                                                            value="{{ pmi_rates.get('fha', {}).get('high_cost_loan_limit', 1089300) }}">
                                                                    </div>
                                                                    <div class="form-text">The maximum loan limit for high-cost areas (2023-2024: $1,089,300)</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-outline-primary" id="saveFhaMipBtn">
                                            <i class="fas fa-save me-1"></i> Save FHA MIP Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- USDA Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#usdaFees">
                                USDA Loan Guarantee Fees
                            </button>
                        </h2>
                        <div id="usdaFees" class="accordion-collapse collapse" data-bs-parent="#pmiAccordion">
                            <div class="accordion-body">
                                <form id="usdaFeesForm" data-loan-type="usda">
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">USDA Guarantee Fee Rates</h6>
                                                        <span class="badge bg-info" data-bs-toggle="tooltip" title="USDA loans have both upfront and annual guarantee fees.">
                                                            <i class="fas fa-info-circle"></i> Fee Structure
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p class="text-muted small mb-4">
                                                        USDA Rural Development loans require both an upfront guarantee fee and an annual fee that's paid monthly.
                                                        These fees are used to sustain the loan program and are typically lower than FHA mortgage insurance.
                                                    </p>

                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-bordered">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Fee Type</th>
                                                                    <th>Rate</th>
                                                                    <th>Description</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>Upfront Guarantee Fee</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control usda-upfront-rate"
                                                                                data-fee-type="upfront"
                                                                                step="0.001" min="0" max="5"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('usda', {}).get('upfront_rate', 1.0)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                        <div class="form-text">One-time fee paid at closing or financed into the loan</div>
                                                                    </td>
                                                                    <td>Applied to the base loan amount</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Annual Fee</td>
                                                                    <td>
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control usda-annual-rate"
                                                                                data-fee-type="annual"
                                                                                step="0.001" min="0" max="1"
                                                                                value="{{ '%.3f'|format(pmi_rates.get('usda', {}).get('annual_rate', 0.35)) }}">
                                                                            <span class="input-group-text">%</span>
                                                                        </div>
                                                                        <div class="form-text">Paid monthly as part of the mortgage payment</div>
                                                                    </td>
                                                                    <td>Applied to the average annual outstanding loan balance</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-outline-primary" id="saveUsdaFeesBtn">
                                            <i class="fas fa-save me-1"></i> Save USDA Fee Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    {% if pmi_rates %}
                        {% for loan_type, rates in pmi_rates.items() %}
                        {% if loan_type != 'va' and loan_type != 'fha' and loan_type != 'usda' %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pmi{{ loop.index }}">
                                    {{ loan_type|replace('_', ' ')|title }} Loan PMI Rates
                                </button>
                            </h2>
                            <div id="pmi{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#pmiAccordion">
                                <div class="accordion-body">
                                    <form id="pmiForm{{ loop.index }}" data-loan-type="{{ loan_type }}">
                                        <div class="row g-4">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header bg-light">
                                                        <h6 class="mb-0">LTV Ranges & Rates</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="pmi-rate-table">
                                                            <div class="table-responsive">
                                                                <table class="table table-sm table-bordered">
                                                                    <thead class="table-light">
                                                                        <tr>
                                                                            <th scope="col">LTV Range</th>
                                                                            <th scope="col">Base Rate</th>
                                                                            <th scope="col"></th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for ltv_range, rate in rates.get('ltv_ranges', {}).items() %}
                                                                        <tr>
                                                                            <td>
                                                                                <input type="text" class="form-control form-control-sm ltv-range-input"
                                                                                       value="{{ ltv_range }}"
                                                                                       data-original-range="{{ ltv_range }}">
                                                                            </td>
                                                                            <td>
                                                                                <div class="input-group input-group-sm">
                                                                                    <input type="number" class="form-control ltv-rate"
                                                                                           data-range="{{ ltv_range }}"
                                                                                           step="0.001" min="0" max="2"
                                                                                           value="{{ '%.3f'|format(rate) }}">
                                                                                    <span class="input-group-text">%</span>
                                                                                </div>
                                                                            </td>
                                                                            <td class="text-center" style="width: 100px;">
                                                                                <div class="btn-group btn-group-sm">
                                                                                    <button type="button" class="btn btn-outline-primary edit-ltv-row" title="Edit">
                                                                                        <i class="fas fa-edit"></i>
                                                                                    </button>
                                                                                    <button type="button" class="btn btn-outline-danger remove-ltv-row" title="Remove">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                    <tfoot>
                                                                        <tr>
                                                                            <td colspan="3" class="text-end">
                                                                                <button type="button" class="btn btn-sm btn-outline-success add-ltv-row">
                                                                                    <i class="fas fa-plus me-1"></i> Add LTV Range
                                                                                </button>
                                                                            </td>
                                                                        </tr>
                                                                    </tfoot>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-4">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header bg-light">
                                                        <h6 class="mb-0">Annual PMI Rates</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        {% if rates.get('annual') %}
                                                            <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">LTV Under 95%</label>
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control annual-rate"
                                                                            data-type="ltv_under_95"
                                                                            step="0.001" min="0" max="5"
                                                                            value="{{ rates.get('annual', {}).get('ltv_under_95', 0) }}">
                                                                        <span class="input-group-text">%</span>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">LTV Over 95%</label>
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control annual-rate"
                                                                            data-type="ltv_over_95"
                                                                            step="0.001" min="0" max="5"
                                                                            value="{{ rates.get('annual', {}).get('ltv_over_95', 0) }}">
                                                                        <span class="input-group-text">%</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% else %}
                                                            <div class="alert alert-info mb-0">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                No annual PMI rates defined for this loan type. Add these rates to enable annual PMI calculation.
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-outline-primary save-pmi-btn"
                                                   data-loan-type="{{ loan_type }}"
                                                   data-form-index="{{ loop.index }}">
                                                <i class="fas fa-save me-1"></i> Save Changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No PMI rates have been configured yet. Please contact your system administrator.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}

<script>
// Clean, simplified implementation for PMI rates management
document.addEventListener('DOMContentLoaded', function() {
    console.log('PMI rates page loaded');

    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Show notification function
    function showNotification(element, message, type = 'success') {
        const alert = document.getElementById(element);
        if (!alert) return;

        // Set content and type
        alert.innerHTML = message;
        alert.className = `alert alert-${type}`;

        // Show alert
        alert.classList.remove('d-none');

        // Auto-hide after 5 seconds
        setTimeout(function() {
            alert.classList.add('d-none');
        }, 5000);
    }

    // --------------------------------
    // Conventional PMI Rates Handling
    // --------------------------------

    const conventionalForms = document.querySelectorAll('form[data-loan-type="conventional"]');
    conventionalForms.forEach(function(form) {
        console.log('Found conventional form with ID:', form.id);

        // Find and setup the save button with direct event binding
        const saveButton = form.querySelector('.save-pmi-btn');
        if (saveButton) {
            console.log('Found save button in form', form.id);

            // Visual indicator
            saveButton.style.border = '2px solid #0d6efd';

            // Direct event handler
            saveButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Save button clicked for conventional form', form.id);

                // Visual feedback
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
                this.disabled = true;

                // Collect LTV data
                const ltvRanges = {};
                form.querySelectorAll('tbody tr').forEach(function(row) {
                    const rangeInput = row.querySelector('.ltv-range-input');
                    const rateInput = row.querySelector('.ltv-rate');

                    if (rangeInput && rateInput) {
                        const range = rangeInput.value.trim();
                        const rate = parseFloat(rateInput.value);

                        if (range && !isNaN(rate)) {
                            ltvRanges[range] = rate;
                            console.log('Added LTV range:', range, '=', rate);
                        }
                    }
                });

                // Prepare data
                const data = {
                    loan_type: 'conventional',
                    ltv_ranges: ltvRanges
                };

                console.log('Sending data to server:', data);

                // Send to server with clear fetch pattern
                fetch('/admin/pmi-rates/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(function(response) {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.json().then(function(errorData) {
                            throw new Error(errorData.error || 'Server error: ' + response.status);
                        });
                    }
                    return response.json();
                })
                .then(function(responseData) {
                    console.log('Server response:', responseData);

                    // Reset button
                    saveButton.innerHTML = '<i class="fas fa-save me-1"></i> Save Changes';
                    saveButton.disabled = false;

                    // Show success notification
                    showNotification('pmiAlert', '<i class="fas fa-check-circle me-1"></i> Conventional PMI rates saved successfully!', 'success');
                })
                .catch(function(error) {
                    console.error('Error saving PMI rates:', error);

                    // Reset button with error indication
                    saveButton.innerHTML = '<i class="fas fa-save me-1"></i> Save Changes';
                    saveButton.disabled = false;

                    // Show error notification
                    showNotification('pmiAlert', '<i class="fas fa-exclamation-circle me-1"></i> Error: ' + error.message, 'danger');
                });
            });
        } else {
            console.error('Could not find save button in form', form.id);
        }

        // Setup edit buttons with direct binding
        form.querySelectorAll('.edit-ltv-row').forEach(function(button) {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                const rangeInput = row.querySelector('.ltv-range-input');
                const rateInput = row.querySelector('.ltv-rate');

                // Toggle between view and edit mode
                if (this.classList.contains('btn-success')) {
                    // We're in edit mode, save changes
                    console.log('Saving edits for range:', rangeInput.value);

                    // Disable inputs and update styling
                    rangeInput.disabled = true;
                    rateInput.disabled = true;
                    rangeInput.classList.remove('bg-light');
                    rateInput.classList.remove('bg-light');

                    // Reset button
                    this.innerHTML = '<i class="fas fa-edit"></i>';
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-primary');
                } else {
                    // We're in view mode, enable editing
                    console.log('Enabling edit mode for range:', rangeInput.value);

                    // Enable inputs and update styling
                    rangeInput.disabled = false;
                    rateInput.disabled = false;
                    rangeInput.classList.add('bg-light');
                    rateInput.classList.add('bg-light');

                    // Focus on range input
                    rangeInput.focus();

                    // Update button
                    this.innerHTML = '<i class="fas fa-save"></i>';
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-success');
                }
            });
        });

        // Setup add row button
        const addButton = form.querySelector('.add-ltv-row');
        if (addButton) {
            addButton.addEventListener('click', function() {
                console.log('Add row button clicked');

                const tbody = form.querySelector('tbody');
                if (!tbody) {
                    console.error('Could not find tbody');
                    return;
                }

                // Create new row
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>
                        <input type="text" class="form-control form-control-sm ltv-range-input"
                            value="" placeholder="e.g. 80.01-85">
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control ltv-rate"
                                data-range="" step="0.001" min="0" max="2" value="0">
                            <span class="input-group-text">%</span>
                        </div>
                    </td>
                    <td class="text-center" style="width: 100px;">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary edit-ltv-row" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger remove-ltv-row" title="Remove">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;

                // Add to table
                tbody.appendChild(newRow);

                // Setup new edit button
                const editButton = newRow.querySelector('.edit-ltv-row');
                if (editButton) {
                    editButton.addEventListener('click', function() {
                        const row = this.closest('tr');
                        const rangeInput = row.querySelector('.ltv-range-input');
                        const rateInput = row.querySelector('.ltv-rate');

                        // Toggle between view and edit mode
                        if (this.classList.contains('btn-success')) {
                            // We're in edit mode, save changes
                            console.log('Saving edits for range:', rangeInput.value);

                            // Disable inputs and update styling
                            rangeInput.disabled = true;
                            rateInput.disabled = true;
                            rangeInput.classList.remove('bg-light');
                            rateInput.classList.remove('bg-light');

                            // Reset button
                            this.innerHTML = '<i class="fas fa-edit"></i>';
                            this.classList.remove('btn-success');
                            this.classList.add('btn-outline-primary');
                        } else {
                            // We're in view mode, enable editing
                            console.log('Enabling edit mode for range:', rangeInput.value);

                            // Enable inputs and update styling
                            rangeInput.disabled = false;
                            rateInput.disabled = false;
                            rangeInput.classList.add('bg-light');
                            rateInput.classList.add('bg-light');

                            // Focus on range input
                            rangeInput.focus();

                            // Update button
                            this.innerHTML = '<i class="fas fa-save"></i>';
                            this.classList.remove('btn-outline-primary');
                            this.classList.add('btn-success');
                        }
                    });
                }

                // Setup new remove button
                const removeButton = newRow.querySelector('.remove-ltv-row');
                if (removeButton) {
                    removeButton.addEventListener('click', function() {
                        newRow.remove();
                        console.log('Row removed');
                    });
                }
            });
        }
    });

    // --------------------------------
    // VA Funding Fee Handling
    // --------------------------------

    // Setup VA funding fee save button
    const vaFundingFeeBtn = document.getElementById('saveVaFundingFeeBtn');
    if (vaFundingFeeBtn) {
        vaFundingFeeBtn.addEventListener('click', function() {
            console.log('VA Funding Fee save button clicked');

            // Collect VA funding fee data
            const fundingFeeData = { funding_fee: {} };

            // Active duty rates
            fundingFeeData.funding_fee.active = {
                less_than_5: {},
                from_5_to_10: {},
                from_10: {}
            };

            // Get active duty fees
            document.querySelectorAll('.va-funding-fee[data-service="active"]').forEach(function(input) {
                const downPayment = input.getAttribute('data-down-payment');
                const use = input.getAttribute('data-use');

                if (!fundingFeeData.funding_fee.active[downPayment]) {
                    fundingFeeData.funding_fee.active[downPayment] = {};
                }

                fundingFeeData.funding_fee.active[downPayment][use] = parseFloat(input.value);
            });

            // Reserve/Guard rates
            fundingFeeData.funding_fee.reserve = {
                less_than_5: {},
                from_5_to_10: {},
                from_10: {}
            };

            // Get reserve/guard fees
            document.querySelectorAll('.va-funding-fee[data-service="reserve"]').forEach(function(input) {
                const downPayment = input.getAttribute('data-down-payment');
                const use = input.getAttribute('data-use');

                if (!fundingFeeData.funding_fee.reserve[downPayment]) {
                    fundingFeeData.funding_fee.reserve[downPayment] = {};
                }

                fundingFeeData.funding_fee.reserve[downPayment][use] = parseFloat(input.value);
            });

            // Disability exemption
            fundingFeeData.funding_fee.disability_exempt = document.getElementById('vaDisabilityExemption').checked;

            // Prepare data
            const data = {
                loan_type: 'va',
                ...fundingFeeData
            };

            console.log('Sending VA funding fee data:', data);

            // Visual feedback
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
            this.disabled = true;

            // Send to server
            fetch('/admin/pmi-rates/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(function(response) {
                console.log('Response status:', response.status);
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || 'Server returned ' + response.status);
                    }
                    return data;
                });
            })
            .then(function(data) {
                console.log('Server response:', data);

                // Reset button
                vaFundingFeeBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save VA Funding Fee Changes';
                vaFundingFeeBtn.disabled = false;

                // Show success notification
                showNotification('pmiAlert', '<i class="fas fa-check-circle me-1"></i> VA Funding Fee rates saved successfully!', 'success');
            })
            .catch(function(error) {
                console.error('Error saving VA funding fees:', error);

                // Reset button
                vaFundingFeeBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save VA Funding Fee Changes';
                vaFundingFeeBtn.disabled = false;

                // Show error notification
                showNotification('pmiAlert', '<i class="fas fa-exclamation-circle me-1"></i> Error: ' + error.message, 'danger');
            });
        });
    }

    // --------------------------------
    // FHA MIP Handling
    // --------------------------------

    // Setup FHA MIP save button
    const fhaMipBtn = document.getElementById('saveFhaMipBtn');
    if (fhaMipBtn) {
        fhaMipBtn.addEventListener('click', function() {
            console.log('FHA MIP save button clicked');

            // Visual feedback
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
            this.disabled = true;

            // Collect FHA MIP data
            const mipData = {
                upfront: parseFloat(document.getElementById('fhaUfmipRate').value),
                annual: {}
            };

            // Get annual rates
            document.querySelectorAll('.fha-annual-mip').forEach(function(input) {
                const term = input.getAttribute('data-term');
                const amount = input.getAttribute('data-amount');
                const ltv = input.getAttribute('data-ltv');

                if (!mipData.annual[term]) {
                    mipData.annual[term] = {};
                }

                if (!mipData.annual[term][amount]) {
                    mipData.annual[term][amount] = {};
                }

                mipData.annual[term][amount][ltv] = parseFloat(input.value);
            });

            // Prepare data
            const data = {
                loan_type: 'fha',
                ...mipData
            };

            console.log('Sending FHA MIP data:', data);

            // Send to server
            fetch('/admin/pmi-rates/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(function(response) {
                console.log('Response status:', response.status);
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || 'Server returned ' + response.status);
                    }
                    return data;
                });
            })
            .then(function(data) {
                console.log('Server response:', data);

                // Reset button
                fhaMipBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save FHA MIP Changes';
                fhaMipBtn.disabled = false;

                // Show success notification
                showNotification('pmiAlert', '<i class="fas fa-check-circle me-1"></i> FHA MIP rates saved successfully!', 'success');
            })
            .catch(function(error) {
                console.error('Error saving FHA MIP:', error);

                // Reset button
                fhaMipBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save FHA MIP Changes';
                fhaMipBtn.disabled = false;

                // Show error notification
                showNotification('pmiAlert', '<i class="fas fa-exclamation-circle me-1"></i> Error: ' + error.message, 'danger');
            });
        });
    }

    // --------------------------------
    // USDA Fees Handling
    // --------------------------------

    // Setup USDA fees save button
    const usdaFeesBtn = document.getElementById('saveUsdaFeesBtn');
    if (usdaFeesBtn) {
        usdaFeesBtn.addEventListener('click', function() {
            console.log('USDA Fees save button clicked');

            // Visual feedback
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
            this.disabled = true;

            // Collect USDA fee data
            const feesData = {
                upfront: parseFloat(document.getElementById('usdaUpfrontFee').value),
                annual: parseFloat(document.getElementById('usdaAnnualFee').value)
            };

            // Prepare data
            const data = {
                loan_type: 'usda',
                ...feesData
            };

            console.log('Sending USDA fees data:', data);

            // Send to server
            fetch('/admin/pmi-rates/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(function(response) {
                console.log('Response status:', response.status);
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || 'Server returned ' + response.status);
                    }
                    return data;
                });
            })
            .then(function(data) {
                console.log('Server response:', data);

                // Reset button
                usdaFeesBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save USDA Fee Changes';
                usdaFeesBtn.disabled = false;

                // Show success notification
                showNotification('pmiAlert', '<i class="fas fa-check-circle me-1"></i> USDA fees saved successfully!', 'success');
            })
            .catch(function(error) {
                console.error('Error saving USDA fees:', error);

                // Reset button
                usdaFeesBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save USDA Fee Changes';
                usdaFeesBtn.disabled = false;

                // Show error notification
                showNotification('pmiAlert', '<i class="fas fa-exclamation-circle me-1"></i> Error: ' + error.message, 'danger');
            });
        });
    }
});
</script>
{% endblock %}
