{% extends "admin/base_admin.html" %}

{% block title %}Mortgage Configuration{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">Mortgage Configuration</h1>
            <p class="text-muted">Manage loan types, limits, and prepaid items settings</p>
        </div>
    </div>

    <!-- Success/Error Notification -->
    <div class="notification-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div id="notification" class="toast align-items-center border-0 fade hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <!-- Notification message will be set dynamically -->
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="loan-types-tab" data-bs-toggle="tab" data-bs-target="#loan-types-tab-pane" type="button" role="tab" aria-controls="loan-types-tab-pane" aria-selected="true">Loan Types</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="limits-tab" data-bs-toggle="tab" data-bs-target="#limits-tab-pane" type="button" role="tab" aria-controls="limits-tab-pane" aria-selected="false">Limits</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="prepaid-tab" data-bs-toggle="tab" data-bs-target="#prepaid-tab-pane" type="button" role="tab" aria-controls="prepaid-tab-pane" aria-selected="false">Prepaid Items</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="seller-contributions-tab" data-bs-toggle="tab" data-bs-target="#seller-contributions-tab-pane" type="button" role="tab" aria-controls="seller-contributions-tab-pane" aria-selected="false">Seller Contributions</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="configTabsContent">
        <!-- Loan Types Tab -->
        <div class="tab-pane fade show active" id="loan-types-tab-pane" role="tabpanel" aria-labelledby="loan-types-tab" tabindex="0">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Loan Types</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addLoanTypeModal">
                        <i class="fas fa-plus"></i> Add Loan Type
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Loan Type</th>
                                    <th>Min Down Payment (%)</th>
                                    <th>Max LTV (%)</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loan_type, config in mortgage_config.loan_types.items() %}
                                <tr>
                                    <td>{{ loan_type }}</td>
                                    <td>{{ config.min_down_payment }}</td>
                                    <td>{{ config.max_ltv }}</td>
                                    <td>{{ config.description }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editLoanType('{{ loan_type }}')" 
                                                    title="Edit this loan type" data-bs-toggle="tooltip">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLoanType('{{ loan_type }}')" 
                                                    title="Delete this loan type" data-bs-toggle="tooltip">
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Limits Tab -->
        <div class="tab-pane fade" id="limits-tab-pane" role="tabpanel" aria-labelledby="limits-tab" tabindex="0">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Global Limits</h5>
                </div>
                <div class="card-body">
                    <form id="limitsForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row g-3">
                            {% for key, value in mortgage_config.limits.items() %}
                            <div class="col-md-6 col-lg-4">
                                <div class="mb-3">
                                    <label class="form-label">{{ key | replace('_', ' ') | title }}</label>
                                    <input type="number" class="form-control" name="{{ key }}" value="{{ value }}" step="0.01" required>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Prepaid Items Tab -->
        <div class="tab-pane fade" id="prepaid-tab-pane" role="tabpanel" aria-labelledby="prepaid-tab" tabindex="0">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Prepaid Items Settings</h5>
                </div>
                <div class="card-body">
                    <form id="prepaidItemsForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row g-3">
                            {% for key, value in mortgage_config.prepaid_items.items() %}
                            {% if key != 'days_interest_prepaid' %}
                            <div class="col-md-6 col-lg-4">
                                <div class="mb-3">
                                    <label class="form-label">{{ key | replace('_', ' ') | title }}</label>
                                    <input type="number" class="form-control" name="{{ key }}" value="{{ value }}" required>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div class="alert alert-info">
                            <strong>Note:</strong> Prepaid interest is now calculated automatically based on the closing date selected by the user,
                            and no longer uses a fixed number of days.
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Seller Contributions Tab -->
        <div class="tab-pane fade" id="seller-contributions-tab-pane" role="tabpanel" aria-labelledby="seller-contributions-tab" tabindex="0">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Maximum Seller Contribution Limits</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Manage the maximum seller contribution percentages for different loan types, occupancy types, and LTV ranges.
                        These limits determine how much of the closing costs sellers can contribute based on loan type and property details.
                    </div>

                    {% if seller_contributions is defined %}
                    <div class="accordion" id="sellerContributionsAccordion">
                        <!-- Conventional Loans -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#conventionalContributions" aria-expanded="true">
                                    Conventional Loans
                                </button>
                            </h2>
                            <div id="conventionalContributions" class="accordion-collapse collapse show"
                                 data-bs-parent="#sellerContributionsAccordion">
                                <div class="accordion-body">
                                    <form id="conventionalContributionsForm" data-loan-type="conventional">
                                        <h6 class="fw-bold mb-3">Primary Residence</h6>
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered table-striped">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>LTV Range</th>
                                                        <th>Maximum Contribution (%)</th>
                                                        <th>Example (based on $300,000)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for range in seller_contributions.get('conventional', {}).get('primary_residence', []) %}
                                                    <tr>
                                                        <td>{{ range.ltv_range }}</td>
                                                        <td>
                                                            <div class="input-group input-group-sm">
                                                                <input type="number" class="form-control contribution-rate"
                                                                    data-occupancy="primary_residence"
                                                                    data-ltv-range="{{ range.ltv_range }}"
                                                                    step="0.1" min="0" max="100"
                                                                    value="{{ range.max_contribution }}">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="contribution-example">
                                                                $300,000 × {{ range.max_contribution }}% = ${{ '{:,}'.format((300000 * range.max_contribution / 100)|int) }}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <h6 class="fw-bold mb-3">Second Home</h6>
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered table-striped">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>LTV Range</th>
                                                        <th>Maximum Contribution (%)</th>
                                                        <th>Example (based on $300,000)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for range in seller_contributions.get('conventional', {}).get('second_home', []) %}
                                                    <tr>
                                                        <td>{{ range.ltv_range }}</td>
                                                        <td>
                                                            <div class="input-group input-group-sm">
                                                                <input type="number" class="form-control contribution-rate"
                                                                    data-occupancy="second_home"
                                                                    data-ltv-range="{{ range.ltv_range }}"
                                                                    step="0.1" min="0" max="100"
                                                                    value="{{ range.max_contribution }}">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="contribution-example">
                                                                $300,000 × {{ range.max_contribution }}% = ${{ '{:,}'.format((300000 * range.max_contribution / 100)|int) }}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <h6 class="fw-bold mb-3">Investment Property</h6>
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered table-striped">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>LTV Range</th>
                                                        <th>Maximum Contribution (%)</th>
                                                        <th>Example (based on $300,000)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for range in seller_contributions.get('conventional', {}).get('investment_property', []) %}
                                                    <tr>
                                                        <td>{{ range.ltv_range }}</td>
                                                        <td>
                                                            <div class="input-group input-group-sm">
                                                                <input type="number" class="form-control contribution-rate"
                                                                    data-occupancy="investment_property"
                                                                    data-ltv-range="{{ range.ltv_range }}"
                                                                    step="0.1" min="0" max="100"
                                                                    value="{{ range.max_contribution }}">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="contribution-example">
                                                                $300,000 × {{ range.max_contribution }}% = ${{ '{:,}'.format((300000 * range.max_contribution / 100)|int) }}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-outline-primary save-contributions-btn"
                                                    data-loan-type="conventional">
                                                <i class="fas fa-save me-1"></i> Save Conventional Limits
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- FHA Loans -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#fhaContributions">
                                    FHA Loans
                                </button>
                            </h2>
                            <div id="fhaContributions" class="accordion-collapse collapse"
                                 data-bs-parent="#sellerContributionsAccordion">
                                <div class="accordion-body">
                                    <form id="fhaContributionsForm" data-loan-type="fha">
                                        <h6 class="fw-bold mb-3">All Occupancy Types</h6>
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered table-striped">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>LTV Range</th>
                                                        <th>Maximum Contribution (%)</th>
                                                        <th>Example (based on $300,000)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for range in seller_contributions.get('fha', {}).get('all_types', []) %}
                                                    <tr>
                                                        <td>{{ range.ltv_range }}</td>
                                                        <td>
                                                            <div class="input-group input-group-sm">
                                                                <input type="number" class="form-control contribution-rate"
                                                                    data-occupancy="all_types"
                                                                    data-ltv-range="{{ range.ltv_range }}"
                                                                    step="0.1" min="0" max="100"
                                                                    value="{{ range.max_contribution }}">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="contribution-example">
                                                                $300,000 × {{ range.max_contribution }}% = ${{ '{:,}'.format((300000 * range.max_contribution / 100)|int) }}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="alert alert-secondary mb-3">
                                            <small>
                                                <i class="fas fa-info-circle me-1"></i>
                                                FHA loans permit seller contributions up to 6% for closing costs, discount points, and other financing concessions.
                                                Any amount exceeding 6% is considered a reduction in the purchase price.
                                            </small>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-outline-primary save-contributions-btn"
                                                    data-loan-type="fha">
                                                <i class="fas fa-save me-1"></i> Save FHA Limits
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- VA Loans -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#vaContributions">
                                    VA Loans
                                </button>
                            </h2>
                            <div id="vaContributions" class="accordion-collapse collapse"
                                 data-bs-parent="#sellerContributionsAccordion">
                                <div class="accordion-body">
                                    <form id="vaContributionsForm" data-loan-type="va">
                                        <h6 class="fw-bold mb-3">All Occupancy Types</h6>
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered table-striped">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>LTV Range</th>
                                                        <th>Maximum Contribution (%)</th>
                                                        <th>Notes</th>
                                                        <th>Example (based on $300,000)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for range in seller_contributions.get('va', {}).get('all_types', []) %}
                                                    <tr>
                                                        <td>{{ range.ltv_range }}</td>
                                                        <td>
                                                            <div class="input-group input-group-sm">
                                                                <input type="number" class="form-control contribution-rate"
                                                                    data-occupancy="all_types"
                                                                    data-ltv-range="{{ range.ltv_range }}"
                                                                    step="0.1" min="0" max="100"
                                                                    value="{{ range.max_contribution }}">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </td>
                                                        <td>{{ range.notes }}</td>
                                                        <td>
                                                            <div class="contribution-example">
                                                                $300,000 × {{ range.max_contribution }}% = ${{ '{:,}'.format((300000 * range.max_contribution / 100)|int) }}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="alert alert-secondary mb-3">
                                            <small>
                                                <i class="fas fa-info-circle me-1"></i>
                                                VA loans allow sellers to pay all closing costs but limit concessions (items like prepaid expenses and discount points) to 4% of the purchase price.
                                            </small>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-outline-primary save-contributions-btn"
                                                    data-loan-type="va">
                                                <i class="fas fa-save me-1"></i> Save VA Limits
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- USDA Loans -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#usdaContributions">
                                    USDA Loans
                                </button>
                            </h2>
                            <div id="usdaContributions" class="accordion-collapse collapse"
                                 data-bs-parent="#sellerContributionsAccordion">
                                <div class="accordion-body">
                                    <form id="usdaContributionsForm" data-loan-type="usda">
                                        <h6 class="fw-bold mb-3">All Occupancy Types</h6>
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered table-striped">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>LTV Range</th>
                                                        <th>Maximum Contribution (%)</th>
                                                        <th>Example (based on $300,000)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for range in seller_contributions.get('usda', {}).get('all_types', []) %}
                                                    <tr>
                                                        <td>{{ range.ltv_range }}</td>
                                                        <td>
                                                            <div class="input-group input-group-sm">
                                                                <input type="number" class="form-control contribution-rate"
                                                                    data-occupancy="all_types"
                                                                    data-ltv-range="{{ range.ltv_range }}"
                                                                    step="0.1" min="0" max="100"
                                                                    value="{{ range.max_contribution }}">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="contribution-example">
                                                                $300,000 × {{ range.max_contribution }}% = ${{ '{:,}'.format((300000 * range.max_contribution / 100)|int) }}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="alert alert-secondary mb-3">
                                            <small>
                                                <i class="fas fa-info-circle me-1"></i>
                                                USDA loans follow a 6% limit similar to FHA loans for closing costs, prepaid expenses, and discount points.
                                            </small>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-outline-primary save-contributions-btn"
                                                    data-loan-type="usda">
                                                <i class="fas fa-save me-1"></i> Save USDA Limits
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Important Notes</h6>
                        </div>
                        <div class="card-body">
                            <ol class="mb-0">
                                {% for note in seller_contributions.get('notes', []) %}
                                <li class="mb-2">{{ note }}</li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Seller contribution data could not be loaded. Please ensure the configuration file exists and is properly formatted.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Loan Type Modal -->
<div class="modal fade" id="addLoanTypeModal" tabindex="-1" aria-labelledby="addLoanTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addLoanTypeForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addLoanTypeModalLabel">Add Loan Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label">Loan Type Name</label>
                        <input type="text" class="form-control" name="loan_type" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Down Payment (%)</label>
                        <input type="number" class="form-control" name="min_down_payment" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Maximum LTV (%)</label>
                        <input type="number" class="form-control" name="max_ltv" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Loan Type</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Loan Type Modal -->
<div class="modal fade" id="editLoanTypeModal" tabindex="-1" aria-labelledby="editLoanTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editLoanTypeForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editLoanTypeModalLabel">Edit Loan Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="original_loan_type" id="editLoanTypeId">
                    <div class="mb-3">
                        <label class="form-label">Loan Type Name</label>
                        <input type="text" class="form-control" name="loan_type" id="editLoanTypeName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Down Payment (%)</label>
                        <input type="number" class="form-control" name="min_down_payment" id="editMinDownPayment" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Maximum LTV (%)</label>
                        <input type="number" class="form-control" name="max_ltv" id="editMaxLtv" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editDescription" rows="2" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to show notifications
    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.classList.remove('bg-success', 'bg-danger');
        notification.classList.add(`bg-${type}`);
        notification.querySelector('.toast-body').textContent = message;

        const bsNotification = new bootstrap.Toast(notification);
        bsNotification.show();
    }

    // Handle limits form submission
    document.getElementById('limitsForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!this.checkValidity()) {
            this.classList.add('was-validated');
            return;
        }

        // Get form data
        const formData = new FormData(this);

        // Send AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/admin/mortgage-config/limits/update', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                // Success
                showNotification('Limits updated successfully!', 'success');
            } else {
                // Error
                let errorMsg = 'Failed to update limits';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMsg = response.error;
                    }
                } catch (e) {
                    console.error('Could not parse error response', e);
                }
                showNotification(errorMsg, 'danger');
            }
        };

        xhr.onerror = function() {
            showNotification('Network error occurred', 'danger');
        };

        xhr.send(formData);
    });

    // Handle prepaid items form submission
    document.getElementById('prepaidItemsForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!this.checkValidity()) {
            this.classList.add('was-validated');
            return;
        }

        // Get form data
        const formData = new FormData(this);

        // Send AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/admin/mortgage-config/prepaid/update', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                // Success
                showNotification('Prepaid items updated successfully!', 'success');
            } else {
                // Error
                let errorMsg = 'Failed to update prepaid items';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMsg = response.error;
                    }
                } catch (e) {
                    console.error('Could not parse error response', e);
                }
                showNotification(errorMsg, 'danger');
            }
        };

        xhr.onerror = function() {
            showNotification('Network error occurred', 'danger');
        };

        xhr.send(formData);
    });

    // Handle add loan type form submission
    document.getElementById('addLoanTypeForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!this.checkValidity()) {
            this.classList.add('was-validated');
            return;
        }

        // Get form data
        const formData = new FormData(this);

        // Send AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/admin/mortgage-config/loan-types/add', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                // Success
                showNotification('Loan type added successfully!', 'success');

                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addLoanTypeModal'));
                modal.hide();

                // Refresh page after a short delay
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                // Error
                let errorMsg = 'Failed to add loan type';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMsg = response.error;
                    }
                } catch (e) {
                    console.error('Could not parse error response', e);
                }
                showNotification(errorMsg, 'danger');
            }
        };

        xhr.onerror = function() {
            showNotification('Network error occurred', 'danger');
        };

        xhr.send(formData);
    });

    // Function to populate edit loan type modal
    function editLoanType(loanType) {
        // Fetch loan type data
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/admin/mortgage-config/loan-types/${loanType}`, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                // Parse response
                try {
                    const response = JSON.parse(xhr.responseText);

                    // Populate form fields
                    document.getElementById('editLoanTypeId').value = loanType;
                    document.getElementById('editLoanTypeName').value = loanType;
                    document.getElementById('editMinDownPayment').value = response.data.min_down_payment;
                    document.getElementById('editMaxLtv').value = response.data.max_ltv;
                    document.getElementById('editDescription').value = response.data.description;

                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editLoanTypeModal'));
                    modal.show();
                } catch (e) {
                    console.error('Could not parse response', e);
                    showNotification('Error fetching loan type data', 'danger');
                }
            } else {
                // Error
                showNotification('Failed to fetch loan type data', 'danger');
            }
        };

        xhr.onerror = function() {
            showNotification('Network error occurred', 'danger');
        };

        xhr.send();
    }

    // Handle edit loan type form submission
    document.getElementById('editLoanTypeForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!this.checkValidity()) {
            this.classList.add('was-validated');
            return;
        }

        // Get form data
        const formData = new FormData(this);
        const loanType = formData.get('original_loan_type');

        // Send AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `/admin/mortgage-config/loan-types/update/${loanType}`, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                // Success
                showNotification('Loan type updated successfully!', 'success');

                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editLoanTypeModal'));
                modal.hide();

                // Refresh page after a short delay
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                // Error
                let errorMsg = 'Failed to update loan type';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMsg = response.error;
                    }
                } catch (e) {
                    console.error('Could not parse error response', e);
                }
                showNotification(errorMsg, 'danger');
            }
        };

        xhr.onerror = function() {
            showNotification('Network error occurred', 'danger');
        };

        xhr.send(formData);
    });

    // Function to delete loan type
    function deleteLoanType(loanType) {
        if (confirm(`Are you sure you want to delete this loan type?`)) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `/admin/mortgage-config/loan-types/delete/${loanType}`, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    // Success
                    showNotification('Loan type deleted successfully!', 'success');

                    // Refresh page after a short delay
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Error
                    let errorMsg = 'Failed to delete loan type';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.error) {
                            errorMsg = response.error;
                        }
                    } catch (e) {
                        console.error('Could not parse error response', e);
                    }
                    showNotification(errorMsg, 'danger');
                }
            };

            xhr.onerror = function() {
                showNotification('Network error occurred', 'danger');
            };

            // Include CSRF token in the request
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            xhr.send(`csrf_token=${csrfToken}`);
        }
    }

    // Update example calculations when contribution rate changes
    document.querySelectorAll('.contribution-rate').forEach(input => {
        input.addEventListener('input', function() {
            const value = parseFloat(this.value) || 0;
            const example = 300000 * (value / 100);
            const formattedExample = new Intl.NumberFormat('en-US').format(Math.round(example));

            // Find the closest contribution example div and update it
            const row = this.closest('tr');
            const exampleCell = row.querySelector('.contribution-example');
            if (exampleCell) {
                exampleCell.textContent = `$300,000 × ${value}% = $${formattedExample}`;
            }
        });
    });

    // Save contribution limits
    document.querySelectorAll('.save-contributions-btn').forEach(button => {
        button.addEventListener('click', function() {
            const loanType = this.getAttribute('data-loan-type');
            saveContributionLimits(loanType);
        });
    });

    function saveContributionLimits(loanType) {
        const form = document.querySelector(`form[data-loan-type="${loanType}"]`);
        const data = { loan_type: loanType };

        // Structure to collect all contribution rates
        const contributions = {};

        // Get all occupancy types for this loan type
        const occupancyTypes = new Set();
        form.querySelectorAll('.contribution-rate').forEach(input => {
            occupancyTypes.add(input.getAttribute('data-occupancy'));
        });

        // For each occupancy type, collect the LTV ranges and rates
        occupancyTypes.forEach(occupancy => {
            contributions[occupancy] = [];

            form.querySelectorAll(`.contribution-rate[data-occupancy="${occupancy}"]`).forEach(input => {
                const ltvRange = input.getAttribute('data-ltv-range');
                const rate = parseFloat(input.value) || 0;

                // Add notes for VA loans
                let item = {
                    ltv_range: ltvRange,
                    max_contribution: rate
                };

                // Add notes for VA loans if present
                if (loanType === 'va' && occupancy === 'all_types') {
                    item.notes = "For closing costs and concessions + reasonable discount points";
                }

                contributions[occupancy].push(item);
            });
        });

        data.contributions = contributions;

        // Send data to server
        fetch('/admin/save_seller_contributions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Seller contribution limits saved successfully!', 'success');
            } else {
                showNotification('Error saving seller contribution limits: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error saving seller contribution limits: ' + error, 'danger');
        });
    }

    $(document).ready(function() {
        // Existing script code...

        // Seller Contributions - Update example calculations dynamically
        $('.contribution-rate-input').on('change', function() {
            const rate = parseFloat($(this).val()) || 0;
            const exampleElement = $(this).closest('tr').find('.contribution-example');
            const purchasePrice = 300000;
            const maxContribution = Math.round(purchasePrice * rate / 100);
            exampleElement.html(`$300,000 × ${rate}% = $${maxContribution.toLocaleString()}`);
        });

        // Save seller contributions for a specific loan type
        $('.save-contributions-btn').on('click', function() {
            const loanType = $(this).data('loan-type');
            const contributionsData = {};

            // Gather data based on loan type
            if (loanType === 'conventional') {
                // Process data for all occupancy types
                contributionsData['primary_residence'] = [];
                $('#conventionalPrimaryTable tr.contribution-row').each(function() {
                    const row = $(this);
                    contributionsData['primary_residence'].push({
                        'ltv_range': row.find('td:first-child').text().trim(),
                        'max_contribution': parseFloat(row.find('.contribution-rate-input').val()) || 0,
                        'notes': row.find('td:nth-child(2)').text().trim()
                    });
                });

                contributionsData['second_home'] = [];
                $('#conventionalSecondHomeTable tr.contribution-row').each(function() {
                    const row = $(this);
                    contributionsData['second_home'].push({
                        'ltv_range': row.find('td:first-child').text().trim(),
                        'max_contribution': parseFloat(row.find('.contribution-rate-input').val()) || 0,
                        'notes': row.find('td:nth-child(2)').text().trim()
                    });
                });

                contributionsData['investment_property'] = [];
                $('#conventionalInvestmentTable tr.contribution-row').each(function() {
                    const row = $(this);
                    contributionsData['investment_property'].push({
                        'ltv_range': row.find('td:first-child').text().trim(),
                        'max_contribution': parseFloat(row.find('.contribution-rate-input').val()) || 0,
                        'notes': row.find('td:nth-child(2)').text().trim()
                    });
                });
            } else {
                // FHA, VA, USDA all have a single "all_types" category
                contributionsData['all_types'] = [];
                $(`#${loanType}Table tr.contribution-row`).each(function() {
                    const row = $(this);
                    contributionsData['all_types'].push({
                        'ltv_range': row.find('td:first-child').text().trim(),
                        'max_contribution': parseFloat(row.find('.contribution-rate-input').val()) || 0,
                        'notes': row.find('td:nth-child(2)').text().trim()
                    });
                });
            }

            // Send data to server
            $.ajax({
                url: '/admin/save_seller_contributions',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    'loan_type': loanType,
                    'contributions': contributionsData
                }),
                success: function(response) {
                    if (response.success) {
                        showNotification('Seller contributions saved successfully.', 'success');
                    } else {
                        showNotification('Error: ' + (response.error || 'Failed to save seller contributions.'), 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Failed to save seller contributions.';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.error) {
                            errorMsg = 'Error: ' + response.error;
                        }
                    } catch (e) {}
                    showNotification(errorMsg, 'danger');
                }
            });
        });
    });
</script>
{% endblock %}
